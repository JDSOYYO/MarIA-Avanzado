<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MarIA â€“ Asistente Inteligente Avanzado con Memoria</title>
<!-- AÃ±adir jsPDF para exportaciÃ³n a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* TODOS LOS ESTILOS ORIGINALES SE MANTIENEN EXACTAMENTE IGUAL */
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 1200px;
  margin: 30px auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  padding: 25px;
}
h1 { 
  margin-top: 0; 
  color: #333;
}
h2 {
  color: #444;
  border-bottom: 2px solid #eee;
  padding-bottom: 8px;
}
textarea {
  width: 100%;
  border-radius: 8px;
  border: 1px solid #ccc;
  padding: 12px;
  font-size: 15px;
  resize: vertical;
  font-family: 'Segoe UI', Arial, sans-serif;
}
button {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  margin: 4px;
  font-weight: 500;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.primary { 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white; 
}
.save-btn { 
  background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
  color: white; 
}
.history-btn { 
  background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
  color: white; 
}
.export-btn { 
  background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
  color: white; 
}
.import-btn { 
  background: linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%);
  color: white; 
}
.quick-btn { 
  background: #e3f2fd; 
  color: #1565c0;
  border: 1px solid #bbdefb;
}
.quick-btn:hover {
  background: #bbdefb;
}
.email-btn {
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #c8e6c9;
}
.business-btn {
  background: #fff3e0;
  color: #ef6c00;
  border: 1px solid #ffe0b2;
}
.social-btn {
  background: #f3e5f5;
  color: #7b1fa2;
  border: 1px solid #e1bee7;
}
.writing-btn {
  background: #e8eaf6;
  color: #303f9f;
  border: 1px solid #c5cae9;
}
.section { 
  margin-top: 25px; 
  padding-bottom: 25px;
  border-bottom: 1px solid #eee;
}
.tutorial {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-left: 5px solid #667eea;
  padding: 18px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.6;
}
.result-block {
  margin-bottom: 15px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f8f9fa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.result-block.email-result {
  border-left: 4px solid #4CAF50;
}
.result-block.writing-result {
  border-left: 4px solid #2196F3;
}
.result-block.social-result {
  border-left: 4px solid #9C27B0;
}
.history-item {
  background: #f9f9f9;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
}
.history-item:hover {
  background: #e8f4ff;
  border-color: #2196F3;
  transform: translateX(5px);
}
.history-item .timestamp {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.saved-prompt {
  background: #e8f5e9;
  border: 1px solid #4CAF50;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
}
.saved-prompt:hover {
  background: #c8e6c9;
  transform: translateX(5px);
}
.saved-prompt .timestamp {
  font-size: 12px;
  color: #2e7d32;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.saved-prompt .actions {
  margin-top: 10px;
  text-align: right;
}
.saved-prompt .actions button {
  padding: 6px 12px;
  font-size: 12px;
  margin-left: 8px;
  border-radius: 6px;
}
.tab-container {
  display: flex;
  border-bottom: 2px solid #ddd;
  margin-bottom: 20px;
  background: #f8f9fa;
  border-radius: 8px 8px 0 0;
  overflow: hidden;
}
.tab {
  padding: 14px 24px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  font-weight: 500;
}
.tab:hover {
  background: #e9ecef;
}
.tab.active {
  border-bottom: 3px solid #667eea;
  background: white;
  font-weight: bold;
  color: #667eea;
}
.tab-content {
  display: none;
  animation: fadeIn 0.3s ease;
}
.tab-content.active {
  display: block;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.prompt-actions {
  display: flex;
  gap: 12px;
  margin-top: 15px;
  flex-wrap: wrap;
}
.quick-actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-top: 15px;
}
.import-export {
  background: #f5f5f5;
  padding: 20px;
  border-radius: 8px;
  margin-top: 20px;
}
.import-export .buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}
.status-message {
  padding: 12px;
  border-radius: 6px;
  margin: 10px 0;
  display: none;
}
.status-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}
.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
.action-tag {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: bold;
  margin-left: 8px;
}
.email-tag { background: #4CAF50; color: white; }
.whatsapp-tag { background: #25D366; color: white; }
.social-tag { background: #667eea; color: white; }
.search-tag { background: #FF9800; color: white; }
.telegram-tag { background: #0088cc; color: white; }
.writing-tag { background: #2196F3; color: white; }
.email-actions {
  margin-top: 10px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.email-actions button {
  padding: 6px 12px;
  font-size: 13px;
}
.recipients-list {
  margin: 8px 0;
  padding: 10px;
  background: #f1f8e9;
  border-radius: 6px;
  font-size: 14px;
}

/* NUEVOS ESTILOS PARA PDF (se aÃ±aden al final) */
.pdf-export-btn {
  background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
  color: white;
  margin-left: 8px;
}

.pdf-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.writing-stats {
  display: flex;
  gap: 15px;
  margin: 10px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 6px;
  font-size: 14px;
}

.writing-stats span {
  padding: 4px 8px;
  background: white;
  border-radius: 4px;
  border: 1px solid #ddd;
}
</style>
</head>

<body>

<div class="container">
<h1>ğŸ¤– MarIA Avanzado con Memoria Completa + PDF</h1>
<p>Asistente inteligente con emails mÃºltiples, redacciones extensas, memoria y exportaciÃ³n a PDF</p>
<p>ğŸ¯ <a href="maria-2.html" target="_blank" style="color: #667eea; font-weight: bold; text-decoration: none; border-bottom: 2px solid #667eea;">ğŸš€ Accede a generador de Prompts</a></p>
<div class="tutorial">
<b>ğŸ“š Ejemplos de uso avanzado (formato original):</b>
<ul>
  <li>- Manda email a cliente@empresa.com con asunto IMPORTANTE y contenido profesional</li>
  <li>- Manda email a: juan@empresa.com, maria@empresa.com, pedro@empresa.com con asunto REUNIÃ“N</li>
  <li>- Escribe redacciÃ³n extensa sobre los beneficios de la inteligencia artificial (800 palabras)</li>
  <li>- Genera artÃ­culo sobre cambio climÃ¡tico y expÃ³rtalo a PDF</li>
  <li>- Publica tuit ACADEMICO sobre mi nuevo libro</li>
  <li>1. Instala ollama (llama 3). 2. Terminal Mac: OLLAMA_ORIGINS="*" ollama serve 3. Abre este HTML. 4. Comprueba estÃ¡ corriendo: http://127.0.0.1:11434</li>
</ul>
</div>

<div class="tab-container">
  <div class="tab active" onclick="showTab('main')">ğŸ“ Principal</div>
  <div class="tab" onclick="showTab('saved')">ğŸ’¾ Prompts Guardados</div>
  <div class="tab" onclick="showTab('history')">ğŸ“Š Historial</div>
  <div class="tab" onclick="showTab('import-export')">ğŸ”„ Importar/Exportar</div>
</div>

<div id="tab-main" class="tab-content active">
  <div class="section">
    <h2>ğŸš€ Acciones RÃ¡pidas</h2>
    <div class="quick-actions-grid">
      <!-- Botones ORIGINALES - EXACTAMENTE IGUAL -->
      <button class="quick-btn" onclick="quick('email')">ğŸ“§ Email editorial</button>
      <button class="quick-btn" onclick="quick('whatsapp')">ğŸ’¬ WhatsApp</button>
      <button class="quick-btn" onclick="quick('telegram')">ğŸ“± Telegram</button>
      <button class="quick-btn" onclick="quick('twitter')">ğŸ¦ Tuit</button>
      <button class="quick-btn" onclick="quick('facebook')">ğŸ“˜ Facebook</button>
      <button class="quick-btn" onclick="quick('linkedin')">ğŸ”— LinkedIn</button>
      <button class="quick-btn" onclick="quick('instagram')">ğŸ“¸ Instagram</button>
      <button class="quick-btn" onclick="quick('texto')">âœï¸ Texto simple</button>
      <button class="quick-btn" onclick="quick('buscar')">ğŸ” Google</button>
      
      <!-- Emails avanzados -->
      <button class="email-btn" onclick="quickEmail('profesional')">ğŸ“§ Email Profesional</button>
      <button class="email-btn" onclick="quickEmail('multiple')">ğŸ“§ Email a Varios</button>
      <button class="email-btn" onclick="quickEmail('comercial')">ğŸ“§ Email Comercial</button>
      <button class="email-btn" onclick="quickEmail('seguimiento')">ğŸ“§ Email Seguimiento</button>
      
      <!-- Redacciones extensas -->
      <button class="writing-btn" onclick="quickWriting('articulo')">ğŸ“„ ArtÃ­culo Blog</button>
      <button class="writing-btn" onclick="quickWriting('informe')">ğŸ“‹ Informe Ejecutivo</button>
      <button class="writing-btn" onclick="quickWriting('redaccion')">ğŸ“ RedacciÃ³n Extensa</button>
      <button class="writing-btn" onclick="quickWriting('ensayo')">ğŸ“š Ensayo AcadÃ©mico</button>
      
      <!-- NUEVO: Redacciones con PDF -->
      <button class="writing-btn" onclick="quickWritingPDF('articulo_pdf')">ğŸ“„ ArtÃ­culo + PDF</button>
      <button class="writing-btn" onclick="quickWritingPDF('informe_pdf')">ğŸ“‹ Informe + PDF</button>
      <button class="writing-btn" onclick="quickWritingPDF('ensayo_pdf')">ğŸ“š Ensayo + PDF</button>
      
      <!-- Redes Sociales -->
      <button class="social-btn" onclick="quick('twitter_hilo')">ğŸ¦ Hilo Twitter</button>
      <button class="social-btn" onclick="quick('linkedin_pro')">ğŸ”— Post LinkedIn</button>
      <button class="social-btn" onclick="quick('instagram_post')">ğŸ“¸ Post Instagram</button>
      
      <!-- BÃºsquedas -->
      <button class="business-btn" onclick="quick('busqueda_avanzada')">ğŸ” BÃºsqueda Avanzada</button>
      
      <!-- Plantillas -->
      <button class="quick-btn" onclick="fillTemplate()">ğŸ“ Plantilla MÃºltiple</button>
      <button class="quick-btn" onclick="fillTemplate('redes')">ğŸ“ Plantilla Redes</button>
      <button class="quick-btn" onclick="fillTemplate('empresarial')">ğŸ“ Plantilla Empresa</button>
    </div>
  </div>

  <div class="section">
    <h2>âœ¨ Ãrea de Trabajo</h2>
    <textarea id="prompt" rows="8" placeholder="Escribe aquÃ­ tus tareas (cada acciÃ³n en una lÃ­nea con guion): 
- Manda email a cliente@empresa.com con asunto IMPORTANTE y contenido profesional
- Manda email a: juan@empresa.com, maria@empresa.com con asunto REUNIÃ“N
- Escribe redacciÃ³n extensa sobre inteligencia artificial (800 palabras)
- Genera informe ejecutivo sobre proyecto y expÃ³rtalo a PDF
- Publica tuit sobre el lanzamiento"></textarea>
    
    <div class="prompt-actions">
      <button class="primary" onclick="generate()">ğŸš€ Ejecutar</button>
      <button class="save-btn" onclick="saveCurrentPrompt()">ğŸ’¾ Guardar Prompt</button>
      <button class="history-btn" onclick="showTab('history')">ğŸ“Š Ver Historial</button>
      <button class="quick-btn" onclick="clearPrompt()">ğŸ—‘ï¸ Limpiar</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ“‹ Resultados</h2>
    <div id="results"></div>
  </div>
</div>

<div id="tab-saved" class="tab-content">
  <div class="section">
    <h2>ğŸ’¾ Prompts Guardados</h2>
    <p>Haz clic en cualquier prompt para cargarlo en el Ã¡rea principal.</p>
    <div class="prompt-actions">
      <button class="export-btn" onclick="exportData('prompts')">ğŸ“¤ Exportar Prompts</button>
      <button onclick="clearSavedPrompts()" style="background: #f44336; color: white;">ğŸ—‘ï¸ Borrar todos</button>
    </div>
    <div id="saved-prompts"></div>
  </div>
</div>

<div id="tab-history" class="tab-content">
  <div class="section">
    <h2>ğŸ“Š Historial de Ejecuciones</h2>
    <p>Ãšltimas consultas realizadas. Haz clic para reutilizar.</p>
    <div class="prompt-actions">
      <button class="export-btn" onclick="exportData('history')">ğŸ“¤ Exportar Historial</button>
      <button onclick="clearHistory()" style="background: #f44336; color: white;">ğŸ—‘ï¸ Borrar historial</button>
    </div>
    <div id="history-list"></div>
  </div>
</div>

<div id="tab-import-export" class="tab-content">
  <div class="section import-export">
    <h2>ğŸ”„ Importar / Exportar Datos</h2>
    
    <div class="section">
      <h3>ğŸ“¤ Exportar Todo</h3>
      <p>Exporta todos tus prompts guardados y el historial en un solo archivo JSON.</p>
      <button class="export-btn" onclick="exportAllData()">ğŸ“¥ Exportar Todo (Prompts + Historial)</button>
    </div>

    <div class="section">
      <h3>ğŸ“¥ Importar Datos</h3>
      <p>Importa datos desde un archivo JSON previamente exportado.</p>
      <input type="file" id="importFile" accept=".json" style="display: none;">
      <button class="import-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ Seleccionar Archivo JSON</button>
      <button class="primary" onclick="importData()" style="margin-top: 10px;">ğŸ“‹ Importar Datos</button>
      <p><small>El archivo debe tener el formato correcto (se valida automÃ¡ticamente).</small></p>
    </div>

    <div class="section">
      <h3>ğŸ”§ Opciones Avanzadas</h3>
      <button onclick="createBackup()" class="quick-btn">ğŸ’¾ Crear Copia de Seguridad</button>
      <button onclick="restoreBackup()" class="quick-btn">ğŸ”„ Restaurar Copia</button>
      <button onclick="resetAllData()" style="background: #f44336; color: white;">âš ï¸ Restablecer Todo</button>
    </div>

    <div id="status-message" class="status-message"></div>
  </div>
</div>

</div>

<script>
// ========== CÃ“DIGO ORIGINAL COMPLETO (SE MANTIENE EXACTO) ==========

// Variables globales para manejar memoria
let savedPrompts = JSON.parse(localStorage.getItem('maria_saved_prompts') || '[]');
let history = JSON.parse(localStorage.getItem('maria_history') || '[]');

// NUEVA: Variable para almacenar redacciones
let writings = JSON.parse(localStorage.getItem('maria_writings') || '[]');

// Mostrar pestaÃ±a activa
function showTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.getElementById('tab-' + tabName).classList.add('active');
  document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
  
  if (tabName === 'saved') {
    loadSavedPrompts();
  } else if (tabName === 'history') {
    loadHistory();
  }
}

// Cargar prompts guardados
function loadSavedPrompts() {
  const container = document.getElementById('saved-prompts');
  if (!container) return;
  
  if (savedPrompts.length === 0) {
    container.innerHTML = '<div class="status-message">No tienes prompts guardados aÃºn. Guarda algunos desde la pestaÃ±a principal.</div>';
    return;
  }
  
  container.innerHTML = savedPrompts.map((prompt, index) => `
    <div class="saved-prompt">
      <div class="timestamp">
        <span>Guardado: ${new Date(prompt.timestamp).toLocaleString()}</span>
        <span class="action-tag ${getActionTagClass(prompt.action)}">${prompt.action || 'Guardado'}</span>
      </div>
      <div onclick="loadPrompt(${index})" style="font-weight: 500; margin: 8px 0; white-space: pre-wrap;">${prompt.text.substring(0, 150)}${prompt.text.length > 150 ? '...' : ''}</div>
      <div class="actions">
        <button onclick="usePrompt(${index})" style="background: #2196F3; color: white;">â†» Usar</button>
        <button onclick="editPrompt(${index})" style="background: #FF9800; color: white;">âœï¸ Editar</button>
        <button onclick="deletePrompt(${index})" style="background: #f44336; color: white;">ğŸ—‘ï¸ Eliminar</button>
      </div>
    </div>
  `).join('');
}

// Obtener clase CSS para etiqueta de acciÃ³n
function getActionTagClass(action) {
  const actionMap = {
    'email': 'email-tag',
    'whatsapp': 'whatsapp-tag',
    'telegram': 'telegram-tag',
    'twitter': 'social-tag',
    'linkedin': 'social-tag',
    'facebook': 'social-tag',
    'instagram': 'social-tag',
    'buscar': 'search-tag',
    'writing': 'writing-tag',
    'articulo': 'writing-tag',
    'informe': 'writing-tag',
    'redaccion': 'writing-tag',
    'ensayo': 'writing-tag'
  };
  return actionMap[action] || 'email-tag';
}

// Cargar historial
function loadHistory() {
  const container = document.getElementById('history-list');
  if (!container) return;
  
  if (history.length === 0) {
    container.innerHTML = '<div class="status-message">No hay historial aÃºn. Ejecuta algunos prompts para comenzar.</div>';
    return;
  }
  
  container.innerHTML = history.map((item, index) => `
    <div class="history-item">
      <div class="timestamp">
        <span>${new Date(item.timestamp).toLocaleString()}</span>
        <span class="action-tag ${getActionTagClass(item.action)}">${item.action || 'EjecuciÃ³n'}</span>
      </div>
      <div onclick="loadHistoryPrompt(${index})" style="margin: 8px 0; white-space: pre-wrap;">${item.prompt.substring(0, 120)}${item.prompt.length > 120 ? '...' : ''}</div>
    </div>
  `).join('');
}

// Guardar prompt actual
function saveCurrentPrompt() {
  const promptText = document.getElementById("prompt").value.trim();
  
  if (!promptText) {
    showStatus('Por favor, escribe un prompt primero', 'error');
    return;
  }
  
  // Detectar tipo de acciÃ³n
  const action = detectActionType(promptText);
  
  // Verificar si ya existe
  const exists = savedPrompts.some(p => p.text === promptText);
  if (exists) {
    if (!confirm('Este prompt ya estÃ¡ guardado. Â¿Deseas guardarlo de nuevo?')) {
      return;
    }
  }
  
  // Guardar prompt
  savedPrompts.unshift({
    text: promptText,
    action: action,
    timestamp: new Date().toISOString()
  });
  
  // Mantener solo los Ãºltimos 100 prompts
  if (savedPrompts.length > 100) {
    savedPrompts = savedPrompts.slice(0, 100);
  }
  
  // Guardar en localStorage
  localStorage.setItem('maria_saved_prompts', JSON.stringify(savedPrompts));
  
  // Mostrar mensaje de Ã©xito
  showStatus('âœ… Prompt guardado correctamente', 'success');
  
  // Recargar lista si estamos en la pestaÃ±a de guardados
  if (document.getElementById('tab-saved').classList.contains('active')) {
    loadSavedPrompts();
  }
}

// Detectar tipo de acciÃ³n del prompt
function detectActionType(promptText) {
  const text = promptText.toLowerCase();
  if (text.includes('email') || text.includes('correo')) return 'email';
  if (text.includes('whatsapp')) return 'whatsapp';
  if (text.includes('telegram')) return 'telegram';
  if (text.includes('twitter') || text.includes('tuit')) return 'twitter';
  if (text.includes('linkedin')) return 'linkedin';
  if (text.includes('facebook')) return 'facebook';
  if (text.includes('instagram')) return 'instagram';
  if (text.includes('buscar') || text.includes('google') || text.includes('bÃºsqueda')) return 'buscar';
  if (text.includes('artÃ­culo') || text.includes('blog') || text.includes('ensayo') || 
      text.includes('redacciÃ³n') || text.includes('informe') || text.includes('extensa') ||
      text.includes('palabras')) return 'writing';
  return 'texto';
}

// Cargar prompt para ver
function loadPrompt(index) {
  if (savedPrompts[index]) {
    document.getElementById("prompt").value = savedPrompts[index].text;
    showTab('main');
    showStatus('âœ… Prompt cargado en el Ã¡rea principal', 'success');
  }
}

// Editar prompt
function editPrompt(index) {
  if (savedPrompts[index]) {
    const newText = prompt('Edita el prompt:', savedPrompts[index].text);
    if (newText !== null && newText.trim() !== '') {
      savedPrompts[index].text = newText.trim();
      savedPrompts[index].timestamp = new Date().toISOString();
      savedPrompts[index].action = detectActionType(newText);
      localStorage.setItem('maria_saved_prompts', JSON.stringify(savedPrompts));
      loadSavedPrompts();
      showStatus('âœ… Prompt editado correctamente', 'success');
    }
  }
}

// Usar prompt directamente
function usePrompt(index) {
  if (savedPrompts[index]) {
    document.getElementById("prompt").value = savedPrompts[index].text;
    showTab('main');
    setTimeout(() => generate(), 300);
  }
}

// Eliminar prompt guardado
function deletePrompt(index) {
  if (confirm('Â¿Eliminar este prompt guardado?')) {
    savedPrompts.splice(index, 1);
    localStorage.setItem('maria_saved_prompts', JSON.stringify(savedPrompts));
    loadSavedPrompts();
    showStatus('âœ… Prompt eliminado', 'success');
  }
}

// Cargar prompt del historial
function loadHistoryPrompt(index) {
  if (history[index]) {
    document.getElementById("prompt").value = history[index].prompt;
    showTab('main');
    showStatus('âœ… Prompt del historial cargado', 'success');
  }
}

// Limpiar Ã¡rea de prompt
function clearPrompt() {
  document.getElementById("prompt").value = '';
}

// Borrar todos los prompts guardados
function clearSavedPrompts() {
  if (savedPrompts.length === 0) {
    showStatus('No hay prompts guardados para borrar', 'error');
    return;
  }
  
  if (confirm('Â¿Borrar todos los prompts guardados? Esta acciÃ³n no se puede deshacer.')) {
    savedPrompts = [];
    localStorage.removeItem('maria_saved_prompts');
    loadSavedPrompts();
    showStatus('âœ… Todos los prompts han sido eliminados', 'success');
  }
}

// Borrar historial
function clearHistory() {
  if (history.length === 0) {
    showStatus('No hay historial para borrar', 'error');
    return;
  }
  
  if (confirm('Â¿Borrar todo el historial? Esta acciÃ³n no se puede deshacer.')) {
    history = [];
    localStorage.removeItem('maria_history');
    loadHistory();
    showStatus('âœ… Historial borrado', 'success');
  }
}

// AÃ±adir al historial
function addToHistory(promptText, action) {
  history.unshift({
    prompt: promptText,
    action: action || detectActionType(promptText),
    timestamp: new Date().toISOString()
  });
  
  if (history.length > 200) {
    history = history.slice(0, 200);
  }
  
  localStorage.setItem('maria_history', JSON.stringify(history));
}

// ========== ACCIONES RÃPIDAS MEJORADAS ==========

// Funciones ORIGINALES con formato correcto
function quick(type){
  const presets = {
    'email': "- Manda email a @gmail.com con asunto IMPORTANTE solicitando trato editorial",
    'whatsapp': "- Escribe WhatsApp a 620158203 indicando ley conmutativa",
    'telegram': "- EnvÃ­a mensaje a Telegram a 34620158203 sobre la reuniÃ³n",
    'twitter': "- Publica tuit ACADEMICO sobre mi nuevo libro",
    'facebook': "- Publica en Facebook sobre mi nuevo libro",
    'linkedin': "- Publica en LinkedIn sobre mi perfil profesional",
    'instagram': "- Prepara texto para Instagram sobre foto del libro",
    'texto': "- ExplÃ­came un concepto de forma sencilla",
    'buscar': "- Busca en Google artÃ­culos sobre inteligencia artificial",
    
    // Nuevas acciones mejoradas
    'twitter_hilo': "- Crea un hilo de Twitter (3-4 tuits) sobre los beneficios de la inteligencia artificial",
    'linkedin_pro': "- Escribe post profesional para LinkedIn sobre tendencias actuales",
    'instagram_post': "- Crea texto para post de Instagram con foto del equipo de trabajo",
    'busqueda_avanzada': "- Busca en Google informaciÃ³n sobre aplicaciones prÃ¡cticas de IA"
  };
  
  const promptText = presets[type];
  if (promptText) {
    document.getElementById("prompt").value = promptText;
    addToHistory(promptText, type);
    showStatus(`âœ… AcciÃ³n rÃ¡pida "${type}" cargada`, 'success');
  }
}

// Funciones para emails avanzados (formato original mejorado)
function quickEmail(type) {
  const emailTemplates = {
    'profesional': "- Manda email a cliente@empresa.com con asunto 'Propuesta de ColaboraciÃ³n' y contenido profesional detallado",
    
    'multiple': `- Manda email a: juan@empresa.com, maria@empresa.com, pedro@empresa.com con asunto 'ReuniÃ³n Importante' y contenido profesional`,
    
    'comercial': "- Manda email a prospecto@cliente.com con asunto 'Oferta Especial' y contenido comercial persuasivo",
    
    'seguimiento': "- Manda email a cliente@empresa.com con asunto 'Seguimiento de nuestra conversaciÃ³n' y contenido profesional de seguimiento"
  };
  
  const promptText = emailTemplates[type];
  document.getElementById("prompt").value = promptText;
  addToHistory(promptText, `email_${type}`);
  showStatus(`âœ… Plantilla de email "${type}" cargada`, 'success');
}

// Funciones para redacciones extensas
function quickWriting(type) {
  const writingTemplates = {
    'articulo': "- Escribe artÃ­culo de blog extenso (1200 palabras) sobre 'El Futuro de la Inteligencia Artificial en 2024'",
    
    'informe': "- Redacta informe ejecutivo completo (1000 palabras) sobre 'Estado Actual del Proyecto de DigitalizaciÃ³n'",
    
    'redaccion': "- Escribe redacciÃ³n extensa y detallada (800 palabras) sobre 'Los DesafÃ­os de la TransformaciÃ³n Digital en las PYMES'",
    
    'ensayo': "- Desarrolla ensayo acadÃ©mico completo (1500 palabras) sobre 'El Impacto Ã‰tico de la Inteligencia Artificial en la Sociedad'"
  };
  
  const promptText = writingTemplates[type];
  document.getElementById("prompt").value = promptText;
  addToHistory(promptText, `writing_${type}`);
  showStatus(`âœ… Plantilla de redacciÃ³n "${type}" cargada`, 'success');
}

// NUEVA: Plantillas para redacciones con PDF
function quickWritingPDF(type) {
  const pdfTemplates = {
    'articulo_pdf': "- Genera artÃ­culo profesional sobre inteligencia artificial y expÃ³rtalo a PDF (1200 palabras)",
    'informe_pdf': "- Redacta informe ejecutivo completo sobre transformaciÃ³n digital y expÃ³rtalo a PDF (1000 palabras)",
    'ensayo_pdf': "- Desarrolla ensayo acadÃ©mico sobre Ã©tica en IA y expÃ³rtalo a PDF (1500 palabras)"
  };
  
  const promptText = pdfTemplates[type];
  if (promptText) {
    document.getElementById("prompt").value = promptText;
    addToHistory(promptText, `writing_pdf_${type}`);
    showStatus(`âœ… Plantilla "${type}" cargada - se exportarÃ¡ a PDF`, 'success');
  }
}

// Plantillas mejoradas con formato correcto
function fillTemplate(type = 'completa') {
  const templates = {
    'completa': `- Manda email a @gmail.com con asunto IMPORTANTE solicitando trato editorial
- Escribe WhatsApp a 620158203 indicando puntos clave
- EnvÃ­a mensaje a Telegram a 34620158203
- Publica en LinkedIn sobre mi perfil
- Busca en Google artÃ­culos recientes sobre IA`,
    
    'redes': `- Publica tuit sobre el lanzamiento del libro
- Comparte post en LinkedIn para profesionales
- Prepara texto para Instagram con foto promocional
- Publica actualizaciÃ³n en Facebook para seguidores`,
    
    'empresarial': `- Manda email a equipo@empresa.com con asunto 'Nuevas PolÃ­ticas' y contenido corporativo
- Redacta comunicado de prensa sobre el lanzamiento del nuevo producto
- Actualiza informaciÃ³n corporativa en el sitio web`
  };
  
  const template = templates[type];
  document.getElementById("prompt").value = template;
  addToHistory(template, 'Plantilla: ' + type);
  showStatus(`âœ… Plantilla "${type}" cargada`, 'success');
}

// ========== IMPORTACIÃ“N/EXPORTACIÃ“N ==========
function exportData(type) {
  let data, filename;
  
  if (type === 'prompts') {
    data = { savedPrompts: savedPrompts };
    filename = `maria_prompts_${new Date().toISOString().split('T')[0]}.json`;
  } else if (type === 'history') {
    data = { history: history };
    filename = `maria_historial_${new Date().toISOString().split('T')[0]}.json`;
  }
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showStatus(`âœ… ${type === 'prompts' ? 'Prompts' : 'Historial'} exportado correctamente`, 'success');
}

function exportAllData() {
  const data = {
    savedPrompts: savedPrompts,
    history: history,
    writings: writings,
    exportDate: new Date().toISOString(),
    version: '1.0'
  };
  
  const filename = `maria_backup_completo_${new Date().toISOString().split('T')[0]}.json`;
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showStatus('âœ… Todos los datos exportados correctamente', 'success');
}

function importData() {
  const fileInput = document.getElementById('importFile');
  if (!fileInput.files.length) {
    showStatus('Por favor, selecciona un archivo primero', 'error');
    return;
  }
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (!data.savedPrompts && !data.history && !data.writings) {
        throw new Error('Formato de archivo invÃ¡lido');
      }
      
      let importedPrompts = 0;
      let importedHistory = 0;
      let importedWritings = 0;
      
      if (data.savedPrompts && Array.isArray(data.savedPrompts)) {
        savedPrompts = [...savedPrompts, ...data.savedPrompts];
        savedPrompts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        savedPrompts = savedPrompts.filter((prompt, index, self) =>
          index === self.findIndex(p => p.text === prompt.text)
        );
        if (savedPrompts.length > 100) {
          savedPrompts = savedPrompts.slice(0, 100);
        }
        localStorage.setItem('maria_saved_prompts', JSON.stringify(savedPrompts));
        importedPrompts = data.savedPrompts.length;
      }
      
      if (data.history && Array.isArray(data.history)) {
        history = [...history, ...data.history];
        history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        history = history.filter((item, index, self) =>
          index === self.findIndex(h => h.prompt === item.prompt && h.timestamp === item.timestamp)
        );
        if (history.length > 200) {
          history = history.slice(0, 200);
        }
        localStorage.setItem('maria_history', JSON.stringify(history));
        importedHistory = data.history.length;
      }
      
      if (data.writings && Array.isArray(data.writings)) {
        writings = [...writings, ...data.writings];
        writings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        writings = writings.filter((writing, index, self) =>
          index === self.findIndex(w => w.id === writing.id)
        );
        if (writings.length > 50) {
          writings = writings.slice(0, 50);
        }
        localStorage.setItem('maria_writings', JSON.stringify(writings));
        importedWritings = data.writings.length;
      }
      
      loadSavedPrompts();
      loadHistory();
      
      showStatus(`âœ… Datos importados: ${importedPrompts} prompts, ${importedHistory} historial, ${importedWritings} redacciones`, 'success');
      fileInput.value = '';
      
    } catch (error) {
      showStatus('âŒ Error al importar archivo: ' + error.message, 'error');
    }
  };
  
  reader.readAsText(file);
}

function createBackup() {
  exportAllData();
}

function restoreBackup() {
  document.getElementById('importFile').click();
}

function resetAllData() {
  if (confirm('âš ï¸ Â¿Restablecer TODOS los datos? Esto borrarÃ¡ prompts, historial y redacciones. No se puede deshacer.')) {
    localStorage.removeItem('maria_saved_prompts');
    localStorage.removeItem('maria_history');
    localStorage.removeItem('maria_writings');
    savedPrompts = [];
    history = [];
    writings = [];
    loadSavedPrompts();
    loadHistory();
    showStatus('âœ… Todos los datos han sido restablecidos', 'success');
  }
}

function showStatus(message, type) {
  const statusDiv = document.getElementById('status-message') || createStatusElement();
  statusDiv.textContent = message;
  statusDiv.className = `status-message status-${type}`;
  statusDiv.style.display = 'block';
  
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 5000);
}

function createStatusElement() {
  const div = document.createElement('div');
  div.id = 'status-message';
  document.querySelector('.import-export').appendChild(div);
  return div;
}

// ========== FUNCIÃ“N GENERATE ORIGINAL (RESTAURADA COMPLETA) ==========
async function generate() {
  const promptText = document.getElementById("prompt").value.trim();
  if (!promptText) {
    showStatus('Por favor, escribe un prompt primero', 'error');
    return;
  }
  
  addToHistory(promptText, 'EjecuciÃ³n completa');
  
  // Procesar lÃ­neas manteniendo el formato original
  const lines = promptText.split("\n").filter(l => l.trim() !== "");
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  for (const line of lines) {
    try {
      // Detectar si es un email a mÃºltiples destinatarios
      const emailMatch = line.match(/^- Manda email a:?\s*(.+?)\s+(?:con asunto|y asunto)\s+(.+?)\s+(?:y contenido|con contenido)\s+(.+)/i);
      const emailMatch2 = line.match(/^- Manda email a\s+(.+?)\s+(?:con asunto|y asunto)\s+(.+?)\s+(?:y contenido|con contenido)\s+(.+)/i);
      
      let res;
      let isEmail = false;
      let isMultipleEmail = false;
      let destinatarios = [];
      let asunto = '';
      let contenidoPrompt = '';
      
      // Procesar emails (formato original)
      if (emailMatch || emailMatch2) {
        isEmail = true;
        const match = emailMatch || emailMatch2;
        
        // Extraer destinatarios (pueden ser mÃºltiples)
        const destinatariosRaw = match[1].trim();
        
        // Verificar si hay mÃºltiples destinatarios separados por comas
        if (destinatariosRaw.includes(',')) {
          isMultipleEmail = true;
          destinatarios = destinatariosRaw.split(',').map(d => d.trim()).filter(d => d);
        } else {
          destinatarios = [destinatariosRaw];
        }
        
        asunto = match[2].trim().replace(/['"]/g, '');
        contenidoPrompt = match[3].trim();
        
        // Crear prompt especÃ­fico para email
        const emailPrompt = `Genera un email profesional con asunto: "${asunto}" y contenido sobre: "${contenidoPrompt}". 
        El email debe incluir saludo formal, cuerpo del mensaje y despedida profesional. 
        Responde SOLO con el contenido del email, sin explicaciones adicionales.`;
        
        const response = await fetch("http://localhost:11434/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "llama3",
            prompt: emailPrompt,
            stream: false,
            options: {
              temperature: 0.7,
              num_predict: 1500
            }
          })
        });

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        const contenido = data.response.trim();
        
        res = {
          accion: "email",
          destinatario: isMultipleEmail ? destinatarios.join(", ") : destinatarios[0],
          destinatarios: isMultipleEmail ? destinatarios : undefined,
          asunto: asunto,
          contenido: contenido
        };
        
      } else {
        // Procesar otras acciones con el sistema original
        const systemInstruction = `
Responde SOLO en JSON vÃ¡lido.

FORMATO GENERAL:
{
 "accion": "whatsapp | twitter | email | texto | buscar | telegram | facebook | linkedin | instagram",
 "destinatario": "",
 "asunto": "",
 "contenido": ""
}

FORMATO MEJORADO SOLO PARA BUSCAR:
{
 "accion": "buscar",
 "consultas": ["consulta 1", "consulta 2"]
}

REGLAS:
- Emails profesionales con asunto
- BÃºsquedas: genera varias consultas Ãºtiles
- No escribas texto fuera del JSON`;

        const response = await fetch("http://localhost:11434/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "llama3",
            prompt: systemInstruction + "\nUsuario: " + line,
            stream: false
          })
        });

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        
        // Intentar parsear JSON
        try {
          res = JSON.parse(data.response);
        } catch (parseError) {
          console.error('Error parsing JSON:', data.response);
          // Si es una redacciÃ³n extensa, crear respuesta directa
          if (line.toLowerCase().includes('redacciÃ³n') || line.toLowerCase().includes('artÃ­culo') || 
              line.toLowerCase().includes('informe') || line.toLowerCase().includes('ensayo')) {
            res = {
              accion: "redaccion",
              contenido: data.response
            };
          } else {
            throw new Error('La respuesta no es JSON vÃ¡lido');
          }
        }
      }
      
      // Procesar la respuesta (FUNCIÃ“N ORIGINAL RESTAURADA)
      await processResponse(res, line, resultsDiv, isEmail, isMultipleEmail, destinatarios, asunto);

    } catch (error) {
      console.error('Error en generate:', error);
      const errorBlock = document.createElement("div");
      errorBlock.className = "result-block";
      errorBlock.innerHTML = `
        <b>âŒ Error procesando: "${line.substring(0, 50)}..."</b><br>
        <small>${error.message}</small><br>
        <small>AsegÃºrate de que Ollama estÃ© corriendo en http://localhost:11434</small>
      `;
      resultsDiv.appendChild(errorBlock);
    }
  }
  
  showStatus('âœ… Comandos procesados correctamente', 'success');
}

// ========== FUNCIÃ“N PROCESAR RESPUESTAS ORIGINAL (RESTAURADA) ==========
async function processResponse(res, originalLine, resultsDiv, isEmail = false, isMultipleEmail = false, destinatarios = [], asunto = '') {
  const action = res.accion || "";
  
  // ğŸ“§ EMAILS (INDIVIDUAL O MÃšLTIPLE) - LÃ“GICA ORIGINAL COMPLETA
  if (action === "email" || isEmail) {
    // SOLO ABRIR GMAIL PARA EMAILS INDIVIDUALES (como estaba originalmente)
    if (!isMultipleEmail && res.destinatario && res.contenido) {
      openEmailInGmail(
        res.destinatario,
        res.asunto || asunto || "Sin asunto",
        res.contenido
      );
    }
    
    const block = document.createElement("div");
    block.className = "result-block email-result";
    
    const emailDestinatarios = isMultipleEmail ? destinatarios : [res.destinatario || ''];
    const emailAsunto = asunto || res.asunto || "Sin asunto";
    const emailContenido = res.contenido || "No se generÃ³ contenido";
    
    if (isMultipleEmail && destinatarios.length > 1) {
      block.innerHTML = `
        <b>ğŸ“§ EMAIL PARA MÃšLTIPLES DESTINATARIOS</b>
        <div class="recipients-list">
          <strong>Para:</strong> ${destinatarios.join(", ")}
        </div>
        <div style="margin: 8px 0; padding: 10px; background: #f1f8e9; border-radius: 6px;">
          <strong>Asunto:</strong> ${emailAsunto}
        </div>
        <textarea rows="10" style="width: 100%; margin-top: 10px; font-size: 14px;">${emailContenido}</textarea>
      `;
      
      // Botones para abrir emails (uno por cada destinatario)
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "email-actions";
      
      if (destinatarios.length > 1) {
        actionsDiv.innerHTML += `
          <button onclick="openMultipleEmailsSeparately(${JSON.stringify(destinatarios)}, ${JSON.stringify(emailAsunto)}, ${JSON.stringify(emailContenido)})" style="background: #4CAF50; color: white;">
            ğŸ“§ Abrir TODOS los emails
          </button>
        `;
      }
      
      // BotÃ³n para abrir el primer email
      if (destinatarios.length > 0) {
        actionsDiv.innerHTML += `
          <button onclick="openEmailInGmail('${destinatarios[0]}', ${JSON.stringify(emailAsunto)}, ${JSON.stringify(emailContenido)})" style="background: #2196F3; color: white;">
            ğŸ“§ Abrir primer email
          </button>
        `;
      }
      
      actionsDiv.innerHTML += `
        <button onclick="copyToClipboard('${escapeText(emailContenido)}')" style="background: #FF9800; color: white;">
          ğŸ“‹ Copiar contenido
        </button>
      `;
      
      block.appendChild(actionsDiv);
      
    } else {
      // Email individual
      const destinatario = emailDestinatarios[0] || res.destinatario || "No especificado";
      
      block.innerHTML = `
        <b>ğŸ“§ EMAIL</b>
        <div style="margin: 8px 0; padding: 10px; background: #e8f5e9; border-radius: 6px;">
          <strong>Para:</strong> ${destinatario}
        </div>
        <div style="margin: 8px 0; padding: 10px; background: #f1f8e9; border-radius: 6px;">
          <strong>Asunto:</strong> ${emailAsunto}
        </div>
        <textarea rows="10" style="width: 100%; margin-top: 10px; font-size: 14px;">${emailContenido}</textarea>
      `;
      
      // BotÃ³n para abrir en Gmail si hay destinatario
      if (destinatario && destinatario !== "No especificado" && emailContenido) {
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "email-actions";
        actionsDiv.innerHTML = `
          <button onclick="openEmailInGmail('${destinatario}', ${JSON.stringify(emailAsunto)}, ${JSON.stringify(emailContenido)})" style="background: #4CAF50; color: white;">
            ğŸ“§ Abrir en Gmail
          </button>
          <button onclick="copyToClipboard('${escapeText(emailContenido)}')" style="background: #2196F3; color: white;">
            ğŸ“‹ Copiar contenido
          </button>
        `;
        block.appendChild(actionsDiv);
      }
    }
    
    resultsDiv.appendChild(block);
  }
  
  // ğŸ“ REDACCIÃ“N EXTENSA (MODIFICADA PARA AÃ‘ADIR PDF)
  else if (action === "redaccion" || (res.contenido && originalLine.toLowerCase().includes('redacciÃ³n'))) {
    const block = document.createElement("div");
    block.className = "result-block writing-result";
    
    const content = res.contenido || "";
    const wordCount = content.split(/\s+/).length;
    
    // Guardar la redacciÃ³n
    const writingId = Date.now();
    const writing = {
      id: writingId,
      title: originalLine.substring(0, 100),
      content: content,
      wordCount: wordCount,
      timestamp: new Date().toISOString(),
      source: originalLine
    };
    
    writings.unshift(writing);
    localStorage.setItem('maria_writings', JSON.stringify(writings));
    
    // FUNCIÃ“N MEJORADA: Limpiar el contenido preservando saltos de lÃ­nea
    let cleanContent = cleanTextForDisplay(content);
    
    block.innerHTML = `
      <b>ğŸ“ REDACCIÃ“N EXTENSA (${wordCount} palabras)</b>
      <div class="writing-stats">
        <span>ğŸ“Š ${wordCount} palabras</span>
        <span>ğŸ“… ${new Date().toLocaleString()}</span>
      </div>
      <textarea rows="15" style="width: 100%; margin-top: 10px; font-size: 14px; line-height: 1.6; white-space: pre-wrap;">${cleanContent}</textarea>
    `;
    
    const actionsDiv = document.createElement("div");
    actionsDiv.className = "pdf-actions";
    actionsDiv.innerHTML = `
      <button onclick="copyToClipboard('${escapeText(cleanContent)}')" style="background: #2196F3; color: white;">
        ğŸ“‹ Copiar contenido
      </button>
      <button onclick="downloadText('${escapeText(cleanContent)}', 'redaccion')" style="background: #4CAF50; color: white;">
        ğŸ’¾ Descargar TXT
      </button>
      <button onclick="exportWritingToPDF(${JSON.stringify(writing)})" class="pdf-export-btn">
        ğŸ“„ Exportar a PDF
      </button>
    `;
    block.appendChild(actionsDiv);
    
    resultsDiv.appendChild(block);
  }
  
  // ğŸ” BÃšSQUEDAS
  else if (action === "buscar") {
    let queries = [];
    
    if (Array.isArray(res.consultas)) {
      queries = res.consultas.slice(0, 3);
    } else if (res.contenido) {
      queries = res.contenido.split("\n").filter(Boolean).slice(0, 3);
    } else {
      queries = [originalLine.substring(0, 100)];
    }
    
    queries.forEach(q => {
      window.open("https://www.google.com/search?q=" + encodeURIComponent(q), "_blank");
    });
    
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = "<b>ğŸ” BÃºsquedas realizadas:</b><br>" + 
      queries.map(q => "â€¢ " + q).join("<br>");
    resultsDiv.appendChild(block);
  }
  
  // ğŸ“± TELEGRAM
  else if (action === "telegram" && res.destinatario && res.contenido) {
    const phone = res.destinatario.toString().replace(/\D/g, '');
    if (phone) {
      window.open(`https://t.me/+${phone}?text=${encodeURIComponent(res.contenido)}`, "_blank");
    }
    
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <b>ğŸ“± Telegram</b>
      <div style="margin: 8px 0; padding: 10px; background: #e3f2fd; border-radius: 6px;">
        <strong>Para:</strong> ${res.destinatario}
      </div>
      <textarea rows="4" style="width: 100%; margin-top: 10px;">${res.contenido}</textarea>
    `;
    resultsDiv.appendChild(block);
  }
  
  // ğŸ’¬ WHATSAPP
  else if (action === "whatsapp" && res.destinatario && res.contenido) {
    const phone = res.destinatario.toString().replace(/\D/g, '');
    if (phone) {
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(res.contenido)}`, "_blank");
    }
    
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <b>ğŸ’¬ WhatsApp</b>
      <div style="margin: 8px 0; padding: 10px; background: #e3f2fd; border-radius: 6px;">
        <strong>Para:</strong> ${res.destinatario}
      </div>
      <textarea rows="4" style="width: 100%; margin-top: 10px;">${res.contenido}</textarea>
    `;
    resultsDiv.appendChild(block);
  }
  
  // ğŸ¦ TWITTER
  else if (action === "twitter" && res.contenido) {
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(res.contenido.substring(0, 280))}`, "_blank");
    
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <b>ğŸ¦ Twitter</b>
      <textarea rows="4" style="width: 100%; margin-top: 10px;">${res.contenido}</textarea>
    `;
    resultsDiv.appendChild(block);
  }
  
  // ğŸ“˜ FACEBOOK
  else if (action === "facebook" && res.contenido) {
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <b>ğŸ“˜ Facebook</b>
      <textarea rows="4" style="width: 100%; margin-top: 10px;">${res.contenido}</textarea>
    `;
    resultsDiv.appendChild(block);
  }
  
  // ğŸ”— LINKEDIN
  else if (action === "linkedin" && res.contenido) {
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <b>ğŸ”— LinkedIn</b>
      <textarea rows="4" style="width: 100%; margin-top: 10px;">${res.contenido}</textarea>
    `;
    resultsDiv.appendChild(block);
  }
  
  // ğŸ“¸ INSTAGRAM
  else if (action === "instagram" && res.contenido) {
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <b>ğŸ“¸ Instagram</b>
      <textarea rows="4" style="width: 100%; margin-top: 10px;">${res.contenido}</textarea>
    `;
    resultsDiv.appendChild(block);
  }
  
  // ğŸ“ TEXTO SIMPLE
  else if (res.contenido) {
    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <b>${action ? action.toUpperCase() : 'TEXTO'}:</b>
      <textarea rows="6" style="width: 100%; margin-top: 10px;">${res.contenido}</textarea>
    `;
    resultsDiv.appendChild(block);
  }
}

// FunciÃ³n para escapar texto para JavaScript
function escapeText(text) {
  return text
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/"/g, '\\"')
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '\\r')
    .replace(/\t/g, '\\t');
}

// FunciÃ³n para limpiar texto de HTML preservando saltos de lÃ­nea
function cleanTextForDisplay(text) {
  if (!text) return "";
  
  let cleanText = text;
  
  // 1. Eliminar etiquetas HTML pero preservar saltos de lÃ­nea
  cleanText = cleanText.replace(/<br\s*\/?>/gi, '\n');
  cleanText = cleanText.replace(/<p\s*.*?>/gi, '\n');
  cleanText = cleanText.replace(/<\/p>/gi, '\n');
  cleanText = cleanText.replace(/<h[1-6]\s*.*?>/gi, '\n\n');
  cleanText = cleanText.replace(/<\/h[1-6]>/gi, '\n\n');
  cleanText = cleanText.replace(/<[^>]*>/g, ' ');
  
  // 2. Eliminar corchetes JSON y Markdown
  cleanText = cleanText.replace(/\{.*?\}/g, ' ');
  cleanText = cleanText.replace(/\[.*?\]/g, ' ');
  cleanText = cleanText.replace(/\*\*.*?\*\*/g, ' ');
  cleanText = cleanText.replace(/\*.*?\*/g, ' ');
  cleanText = cleanText.replace(/`.*?`/g, ' ');
  cleanText = cleanText.replace(/#{1,6}\s?/g, '');
  
  // 3. Reemplazar caracteres de escape correctamente
  cleanText = cleanText.replace(/\\n/g, '\n');
  cleanText = cleanText.replace(/\\r/g, '\n');
  cleanText = cleanText.replace(/\\t/g, '    ');
  
  // 4. Preservar saltos de lÃ­nea mÃºltiples para pÃ¡rrafos
  // Primero normalizamos saltos mÃºltiples
  cleanText = cleanText.replace(/\n\s*\n\s*\n/g, '\n\n');
  cleanText = cleanText.replace(/\n\s*\n/g, '\n\n');
  
  // 5. Eliminar espacios mÃºltiples pero preservar saltos
  cleanText = cleanText.replace(/[ \t]+/g, ' ');
  cleanText = cleanText.replace(/[ ]+\n/g, '\n');
  cleanText = cleanText.replace(/\n[ ]+/g, '\n');
  
  // 6. Limpiar espacios al inicio y final
  cleanText = cleanText.trim();
  
  // 7. Asegurar que haya saltos de lÃ­nea entre pÃ¡rrafos largos
  // Dividir en oraciones y aÃ±adir saltos despuÃ©s de puntos
  let sentences = cleanText.split('. ');
  if (sentences.length > 3) {
    cleanText = sentences.join('.\n\n');
  }
  
  return cleanText;
}

// FunciÃ³n para limpiar texto para PDF (preservando saltos)
function cleanTextForPDF(text) {
  if (!text) return "";
  
  let cleanText = text;
  
  // Eliminar HTML pero preservar estructura de pÃ¡rrafos
  cleanText = cleanText.replace(/<br\s*\/?>/gi, '\n');
  cleanText = cleanText.replace(/<p\s*.*?>/gi, '\n');
  cleanText = cleanText.replace(/<\/p>/gi, '\n\n');
  cleanText = cleanText.replace(/<h[1-6]\s*.*?>/gi, '\n\n');
  cleanText = cleanText.replace(/<\/h[1-6]>/gi, '\n\n');
  cleanText = cleanText.replace(/<[^>]*>/g, ' ');
  
  // Eliminar markdown
  cleanText = cleanText.replace(/[#*`_~\[\]\(\)\{\}]+/g, ' ');
  
  // Normalizar saltos de lÃ­nea
  cleanText = cleanText.replace(/\n\s*\n\s*\n/g, '\n\n');
  cleanText = cleanText.replace(/\n\s*\n/g, '\n\n');
  cleanText = cleanText.replace(/[ \t]+/g, ' ');
  
  return cleanText.trim();
}

// FunciÃ³n para abrir email en Gmail (lÃ³gica original)
function openEmailInGmail(destinatario, asunto, contenido) {
  const gmailUrl =
    "https://mail.google.com/mail/?view=cm&fs=1" +
    "&to=" + encodeURIComponent(destinatario) +
    "&su=" + encodeURIComponent(asunto || "") +
    "&body=" + encodeURIComponent(contenido || "");

  window.open(gmailUrl, "_blank");
}

function openMultipleEmailsSeparately(destinatarios, asunto, contenido) {
  destinatarios.forEach(dest => {
    openEmailInGmail(dest, asunto, contenido);
  });
}

// FunciÃ³n para copiar al portapapeles (CORREGIDA)
function copyToClipboard(text) {
  // Decodificar los saltos de lÃ­nea escapados
  const decodedText = text
    .replace(/\\n/g, '\n')
    .replace(/\\r/g, '\r')
    .replace(/\\t/g, '\t')
    .replace(/\\'/g, "'")
    .replace(/\\"/g, '"')
    .replace(/\\\\/g, '\\');
  
  navigator.clipboard.writeText(decodedText).then(() => {
    showStatus('âœ… Contenido copiado al portapapeles', 'success');
  }).catch(err => {
    showStatus('âŒ Error al copiar: ' + err, 'error');
  });
}

// FunciÃ³n para descargar texto como archivo (CORREGIDA)
function downloadText(content, filename = 'redaccion') {
  // Decodificar el contenido escapado
  const decodedContent = content
    .replace(/\\n/g, '\n')
    .replace(/\\r/g, '\r')
    .replace(/\\t/g, '\t')
    .replace(/\\'/g, "'")
    .replace(/\\"/g, '"')
    .replace(/\\\\/g, '\\');
  
  const blob = new Blob([decodedContent], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${filename}_${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showStatus('âœ… Texto descargado como archivo TXT', 'success');
}

// ========== NUEVAS FUNCIONES PARA EXPORTACIÃ“N PDF (AÃ‘ADIDAS AL FINAL) ==========

// Inicializar jsPDF
const { jsPDF } = window.jspdf;

// FunciÃ³n para exportar una redacciÃ³n a PDF (CORREGIDA)
function exportWritingToPDF(writing) {
  try {
    // Crear nuevo documento PDF
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    // Configurar fuente y tamaÃ±o
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    
    // TÃ­tulo del documento
    const title = writing.title.length > 50 ? writing.title.substring(0, 50) + '...' : writing.title;
    
    // TÃ­tulo principal
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.text("REDACCIÃ“N GENERADA POR MARIA", 105, 20, { align: 'center' });
    
    // LÃ­nea decorativa
    doc.setDrawColor(66, 133, 244);
    doc.setLineWidth(0.5);
    doc.line(20, 25, 190, 25);
    
    // InformaciÃ³n del documento
    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.text(`TÃ­tulo: ${title}`, 20, 35);
    doc.text(`Generado: ${new Date(writing.timestamp).toLocaleString()}`, 20, 42);
    doc.text(`Palabras: ${writing.wordCount}`, 20, 49);
    
    // LÃ­nea separadora
    doc.setDrawColor(200, 200, 200);
    doc.line(20, 55, 190, 55);
    
    // Contenido principal
    doc.setFontSize(12);
    
    // Limpiar el contenido para PDF preservando saltos
    let cleanContent = cleanTextForPDF(writing.content);
    
    // IMPORTANTE: jsPDF necesita el texto con saltos de lÃ­nea reales
    // Asegurarnos de que hay saltos de lÃ­nea entre pÃ¡rrafos
    cleanContent = cleanContent.replace(/\n\n/g, '\n \n');
    
    // Dividir el texto en lÃ­neas
    const lines = doc.splitTextToSize(cleanContent, 170);
    
    let y = 65;
    const pageHeight = doc.internal.pageSize.height;
    
    for (let i = 0; i < lines.length; i++) {
      if (y > pageHeight - 20) {
        doc.addPage();
        y = 20;
        
        // AÃ±adir encabezado en pÃ¡ginas adicionales
        doc.setFontSize(10);
        doc.setFont("helvetica", "italic");
        doc.text(`ContinuaciÃ³n: ${title}`, 20, 15);
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 18, 190, 18);
        
        y = 25;
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
      }
      doc.text(lines[i], 20, y);
      y += 7;
    }
    
    // Pie de pÃ¡gina en cada pÃ¡gina
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setFont("helvetica", "italic");
      doc.text(`PÃ¡gina ${i} de ${totalPages} - Generado por MarIA Assistant`, 105, pageHeight - 10, { align: 'center' });
    }
    
    // Guardar el PDF
    const safeTitle = writing.title.replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ¼Ã±]/gi, '_').substring(0, 30).toLowerCase();
    const filename = `redaccion_${safeTitle}_${Date.now()}.pdf`;
    doc.save(filename);
    
    showStatus(`âœ… PDF exportado: ${filename}`, 'success');
    
  } catch (error) {
    console.error('Error exportando PDF:', error);
    showStatus('âŒ Error al exportar PDF: ' + error.message, 'error');
  }
}

// Inicializar al cargar la pÃ¡gina
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('importFile').addEventListener('change', function() {
    if (this.files.length) {
      showStatus('Archivo seleccionado. Haz clic en "Importar Datos" para continuar.', 'success');
    }
  });
  
  loadSavedPrompts();
  loadHistory();
  
  // Mensaje inicial de ayuda
  setTimeout(() => {
    if (savedPrompts.length === 0 && history.length === 0) {
      showStatus('ğŸ’¡ Usa las acciones rÃ¡pidas para empezar. Â¡Prueba las nuevas funciones de PDF!', 'success');
    }
  }, 1000);
});
</script>

</body>
</html>
