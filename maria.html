<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MarIA ‚Äì Asistente Inteligente Avanzado con Memoria</title>
<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 1100px;
  margin: 30px auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  padding: 25px;
}
h1 { margin-top: 0; }
textarea {
  width: 100%;
  border-radius: 8px;
  border: 1px solid #ccc;
  padding: 10px;
  font-size: 15px;
  resize: vertical;
}
button {
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.primary { background: black; color: white; }
.quick-btn { background: #eee; margin: 4px; }
.save-btn { background: #4CAF50; color: white; }
.history-btn { background: #2196F3; color: white; }
.section { 
  margin-top: 20px; 
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}
.tutorial {
  background: #f7f7f7;
  border-left: 5px solid black;
  padding: 15px;
  border-radius: 8px;
  font-size: 14px;
}
.contacts button {
  background: #eee;
  width: 100%;
  text-align: left;
  margin-bottom: 5px;
}
.result-block {
  margin-bottom: 15px;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #fafafa;
}
.history-item {
  background: #f9f9f9;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.history-item:hover {
  background: #e8f4ff;
}
.history-item .timestamp {
  font-size: 12px;
  color: #666;
  margin-bottom: 5px;
}
.saved-prompt {
  background: #e8f5e9;
  border: 1px solid #4CAF50;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.saved-prompt:hover {
  background: #c8e6c9;
}
.saved-prompt .actions {
  margin-top: 8px;
  text-align: right;
}
.saved-prompt .actions button {
  padding: 4px 8px;
  font-size: 12px;
  margin-left: 5px;
}
.tab-container {
  display: flex;
  border-bottom: 1px solid #ddd;
  margin-bottom: 15px;
}
.tab {
  padding: 10px 20px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
}
.tab.active {
  border-bottom: 3px solid black;
  font-weight: bold;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.prompt-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.grid-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-top: 20px;
}
@media (max-width: 768px) {
  .grid-container {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<div class="container">
<h1>ü§ñ MarIA Avanzado con Memoria</h1>
<p>Asistente inteligente con historial y prompts guardados</p>

<div class="tutorial">
<b>Ejemplos de uso:</b>
<ul>
  <li>- Manda email a @gmail.com con asunto IMPORTANTE solicitando trato editorial</li>
  <li>- Escribe WhatsApp a 620158203 indicando ley conmutativa</li>
  <li>- Publica tuit ACADEMICO sobre mi nuevo libro</li>
  <li>- Busca art√≠culos recientes sobre IA en Google</li>
  <li>1. Instala ollama (llama 3). 2. Terminal Mac: OLLAMA_ORIGINS="*" ollama serve 3. Abre este HTML. 4. Comprueba est√° corriendo: http://127.0.0.1:11434</li>
</ul>
</div>

<div class="tab-container">
  <div class="tab active" onclick="showTab('main')">Principal</div>
  <div class="tab" onclick="showTab('saved')">Prompts Guardados</div>
  <div class="tab" onclick="showTab('history')">Historial</div>
</div>

<div id="tab-main" class="tab-content active">
  <div class="section">
    <b>Acciones r√°pidas:</b><br>
    <button class="quick-btn" onclick="quick('email')">üìß Email editorial</button>
    <button class="quick-btn" onclick="quick('whatsapp')">üí¨ WhatsApp</button>
    <button class="quick-btn" onclick="quick('telegram')">üì± Telegram</button>
    <button class="quick-btn" onclick="quick('twitter')">üê¶ Tuit</button>
    <button class="quick-btn" onclick="quick('facebook')">üìò Facebook</button>
    <button class="quick-btn" onclick="quick('linkedin')">üîó LinkedIn</button>
    <button class="quick-btn" onclick="quick('instagram')">üì∏ Instagram</button>
    <button class="quick-btn" onclick="quick('texto')">‚úçÔ∏è Texto</button>
    <button class="quick-btn" onclick="quick('buscar')">üîé Google</button>
    <button class="quick-btn" onclick="fillTemplate()">üìù Plantilla</button>
  </div>

  <div class="section">
    <textarea id="prompt" rows="6" placeholder="Escribe aqu√≠ tus tareas, una por l√≠nea..."></textarea>
    <div class="prompt-actions">
      <button class="primary" onclick="generate()">Ejecutar</button>
      <button class="save-btn" onclick="saveCurrentPrompt()">üíæ Guardar Prompt</button>
    </div>
  </div>

  <div class="section">
    <h3>Resultados</h3>
    <div id="results"></div>
  </div>

  <div class="section">
    <h3>Contactos recientes</h3>
    <div id="contacts"></div>
  </div>
</div>

<div id="tab-saved" class="tab-content">
  <div class="section">
    <h3>Prompts Guardados</h3>
    <p>Haz clic en cualquier prompt para cargarlo en el √°rea principal.</p>
    <div id="saved-prompts"></div>
    <button onclick="clearSavedPrompts()" style="background: #f44336; color: white;">üóëÔ∏è Borrar todos los prompts</button>
  </div>
</div>

<div id="tab-history" class="tab-content">
  <div class="section">
    <h3>Historial de Ejecuciones</h3>
    <p>√öltimas consultas realizadas. Haz clic para reutilizar.</p>
    <div id="history-list"></div>
    <button onclick="clearHistory()" style="background: #f44336; color: white;">üóëÔ∏è Borrar historial</button>
  </div>
</div>

</div>

<script>
// Variables globales para manejar memoria
let savedPrompts = JSON.parse(localStorage.getItem('maria_saved_prompts') || '[]');
let history = JSON.parse(localStorage.getItem('maria_history') || '[]');

// Mostrar pesta√±a activa
function showTab(tabName) {
  // Ocultar todas las pesta√±as
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Mostrar pesta√±a seleccionada
  document.getElementById('tab-' + tabName).classList.add('active');
  document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
  
  // Cargar datos de la pesta√±a si es necesario
  if (tabName === 'saved') {
    loadSavedPrompts();
  } else if (tabName === 'history') {
    loadHistory();
  }
}

// Cargar prompts guardados
function loadSavedPrompts() {
  const container = document.getElementById('saved-prompts');
  if (!container) return;
  
  if (savedPrompts.length === 0) {
    container.innerHTML = '<p>No tienes prompts guardados a√∫n.</p>';
    return;
  }
  
  container.innerHTML = savedPrompts.map((prompt, index) => `
    <div class="saved-prompt">
      <div class="timestamp">Guardado: ${new Date(prompt.timestamp).toLocaleString()}</div>
      <div onclick="loadPrompt(${index})">${prompt.text}</div>
      <div class="actions">
        <button onclick="usePrompt(${index})" style="background: #2196F3; color: white;">Usar</button>
        <button onclick="deletePrompt(${index})" style="background: #f44336; color: white;">Eliminar</button>
      </div>
    </div>
  `).join('');
}

// Cargar historial
function loadHistory() {
  const container = document.getElementById('history-list');
  if (!container) return;
  
  if (history.length === 0) {
    container.innerHTML = '<p>No hay historial a√∫n.</p>';
    return;
  }
  
  container.innerHTML = history.map((item, index) => `
    <div class="history-item">
      <div class="timestamp">${new Date(item.timestamp).toLocaleString()} - ${item.action}</div>
      <div onclick="loadHistoryPrompt(${index})">${item.prompt}</div>
    </div>
  `).join('');
}

// Guardar prompt actual
function saveCurrentPrompt() {
  const promptText = document.getElementById("prompt").value.trim();
  
  if (!promptText) {
    alert('Por favor, escribe un prompt primero');
    return;
  }
  
  // Verificar si ya existe
  const exists = savedPrompts.some(p => p.text === promptText);
  if (exists) {
    if (!confirm('Este prompt ya est√° guardado. ¬øDeseas guardarlo de nuevo?')) {
      return;
    }
  }
  
  // Guardar prompt
  savedPrompts.unshift({
    text: promptText,
    timestamp: new Date().toISOString()
  });
  
  // Mantener solo los √∫ltimos 50 prompts
  if (savedPrompts.length > 50) {
    savedPrompts = savedPrompts.slice(0, 50);
  }
  
  // Guardar en localStorage
  localStorage.setItem('maria_saved_prompts', JSON.stringify(savedPrompts));
  
  // Mostrar mensaje de √©xito
  alert('Prompt guardado correctamente');
  
  // Recargar lista si estamos en la pesta√±a de guardados
  if (document.getElementById('tab-saved').classList.contains('active')) {
    loadSavedPrompts();
  }
}

// Cargar prompt para ver
function loadPrompt(index) {
  if (savedPrompts[index]) {
    document.getElementById("prompt").value = savedPrompts[index].text;
    showTab('main');
  }
}

// Usar prompt directamente
function usePrompt(index) {
  if (savedPrompts[index]) {
    document.getElementById("prompt").value = savedPrompts[index].text;
    showTab('main');
    generate(); // Ejecutar autom√°ticamente
  }
}

// Eliminar prompt guardado
function deletePrompt(index) {
  if (confirm('¬øEliminar este prompt guardado?')) {
    savedPrompts.splice(index, 1);
    localStorage.setItem('maria_saved_prompts', JSON.stringify(savedPrompts));
    loadSavedPrompts();
  }
}

// Cargar prompt del historial
function loadHistoryPrompt(index) {
  if (history[index]) {
    document.getElementById("prompt").value = history[index].prompt;
    showTab('main');
  }
}

// Borrar todos los prompts guardados
function clearSavedPrompts() {
  if (savedPrompts.length === 0) {
    alert('No hay prompts guardados para borrar');
    return;
  }
  
  if (confirm('¬øBorrar todos los prompts guardados? Esta acci√≥n no se puede deshacer.')) {
    savedPrompts = [];
    localStorage.removeItem('maria_saved_prompts');
    loadSavedPrompts();
  }
}

// Borrar historial
function clearHistory() {
  if (history.length === 0) {
    alert('No hay historial para borrar');
    return;
  }
  
  if (confirm('¬øBorrar todo el historial? Esta acci√≥n no se puede deshacer.')) {
    history = [];
    localStorage.removeItem('maria_history');
    loadHistory();
  }
}

// A√±adir al historial
function addToHistory(promptText, action) {
  history.unshift({
    prompt: promptText,
    action: action || 'Ejecuci√≥n',
    timestamp: new Date().toISOString()
  });
  
  // Mantener solo los √∫ltimos 100 registros
  if (history.length > 100) {
    history = history.slice(0, 100);
  }
  
  localStorage.setItem('maria_history', JSON.stringify(history));
}

// Funciones originales (modificadas para incluir historial)
function quick(type){
  const presets = {
    email: "Manda email a @gmail.com con asunto IMPORTANTE solicitando -",
    whatsapp: "Escribe WhatsApp a 620158203",
    telegram: "Env√≠a mensaje a Telegram a 34620158203",
    twitter: "Publica tuit ACADEMICO sobre mi nuevo libro",
    facebook: "Publica en Facebook sobre mi nuevo libro",
    linkedin: "Publica en LinkedIn sobre mi perfil profesional",
    instagram: "Prepara texto para Instagram sobre foto del libro",
    texto: "Expl√≠came un concepto de forma sencilla",
    buscar: "Busca en Google art√≠culos sobre inteligencia artificial"
  };
  const promptText = presets[type];
  document.getElementById("prompt").value = promptText;
  addToHistory(promptText, `Acci√≥n r√°pida: ${type}`);
}

function fillTemplate(){
  const template = `- Manda email a @gmail.com con asunto IMPORTANTE solicitando trato editorial
- Escribe WhatsApp a 620158203 indicando puntos clave
- Env√≠a mensaje a Telegram a 34620158203
- Publica en LinkedIn sobre mi perfil
- Busca en Google art√≠culos recientes sobre IA`;
  
  document.getElementById("prompt").value = template;
  addToHistory(template, 'Plantilla cargada');
}

async function generate(){
  const promptText = document.getElementById("prompt").value.trim();
  if (!promptText) {
    alert('Por favor, escribe un prompt primero');
    return;
  }
  
  // A√±adir al historial
  addToHistory(promptText, 'Ejecuci√≥n completa');
  
  const lines = promptText.split("\n").filter(l => l.trim() !== "");
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  const systemInstruction = `
Responde SOLO en JSON v√°lido.

FORMATO GENERAL:
{
 "accion": "whatsapp | twitter | email | texto | buscar | telegram | facebook | linkedin | instagram",
 "destinatario": "",
 "asunto": "",
 "contenido": ""
}

FORMATO MEJORADO SOLO PARA BUSCAR:
{
 "accion": "buscar",
 "consultas": ["consulta 1", "consulta 2"]
}

REGLAS:
- Emails profesionales con asunto
- B√∫squedas: genera varias consultas √∫tiles
- No escribas texto fuera del JSON
`;

  for(const line of lines){
    try{
      const r = await fetch("http://localhost:11434/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "llama3",
          prompt: systemInstruction + "\nUsuario: " + line,
          stream: false
        })
      });

      const data = await r.json();
      const res = JSON.parse(data.response);

      /* üîé GOOGLE MEJORADO + COMPATIBLE */
      if(res.accion === "buscar"){
        let queries = [];

        if(Array.isArray(res.consultas)){
          queries = res.consultas;
        } else if(res.contenido){
          queries = res.contenido.split("\n").filter(Boolean);
        }

        queries.forEach(q=>{
          window.open("https://www.google.com/search?q=" + encodeURIComponent(q), "_blank");
        });

        const block = document.createElement("div");
        block.className = "result-block";
        block.innerHTML = "<b>B√∫squedas:</b><br>" + queries.map(q=>"üîé "+q).join("<br>");
        resultsDiv.appendChild(block);
        continue;
      }

      if(res.accion === "whatsapp"){
        window.open(`https://wa.me/${res.destinatario}?text=${encodeURIComponent(res.contenido)}`);
      }
      if(res.accion === "telegram"){
        const phone = res.destinatario.replace(/\s+/g, "");
        window.open(
          `https://t.me/+${phone}?text=${encodeURIComponent(res.contenido)}`,
          "_blank"
        );
      }

      if(res.accion === "twitter"){
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(res.contenido)}`);
      }
      if(res.accion === "email"){
        window.open(
          "https://mail.google.com/mail/?view=cm&fs=1&to=" +
          encodeURIComponent(res.destinatario) +
          "&su=" + encodeURIComponent(res.asunto) +
          "&body=" + encodeURIComponent(res.contenido)
        );
      }

      const block = document.createElement("div");
      block.className = "result-block";
      block.innerHTML = `<textarea rows="5">${res.contenido}</textarea>`;
      resultsDiv.appendChild(block);

    } catch(e){
      console.error(e);
      const errorBlock = document.createElement("div");
      errorBlock.className = "result-block";
      errorBlock.innerHTML = `<b>Error:</b> ${e.message}`;
      resultsDiv.appendChild(errorBlock);
    }
  }
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  // Cargar datos iniciales
  loadSavedPrompts();
  loadHistory();
});
</script>

</body>
</html>